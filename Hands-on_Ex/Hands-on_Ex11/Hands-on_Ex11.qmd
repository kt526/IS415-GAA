---
title: "Hands-on Exercise 11: Calibrating Spatial Interaction Models with R"
format: html
execute:
  eval: true
  echo: true
  warning: false
date: 03/25/2024
code-annotations: hover
toc-depth: 3
---

# 1.0 Introduction

## 1.1 Getting Started

In this hands-on exercise, we will learn how to **calibrate SIM to determine factors affecting the public bus passenger flows during the morning peak in Singapore**.

## 1.2 Overview

Spatial Interaction Models (SIMs) are mathematical models for estimating flows between spatial entities developed by Alan Wilson in the late 1960s and early 1970, with considerable uptake and refinement for transport modelling.

There are four main types of traditional SIMs:

-   Unconstrained

-   Production-constrained

-   Attraction-constrained

-   Doubly-constrained

## 1.3 Installing and loading R packages

```{r}
pacman::p_load(tmap, sf, sp,
               performance, reshape2,
               ggpubr, tidyverse,
               DT, stplanr)
```

# 2.0 Data Acquisition

We will be using 2 datasets in this exercise:

-   Weekday morning peak passenger flows at planning subzone level (i.e. `od_data.rds`)

-   URA Master Plan 2019 Planning Subzone boundary in simple feature tibble data frame format (i.e. `mpsz.rds`)

# 3.0 Geospatial and Aspatial Data Handling

We will be using the *st_read()* from **sf** package to import the data into RStudio.

## 3.1 Importing Geospatial Data

```{r}
mpsz <- st_read("data/geospatial",
                layer = "MPSZ-2019")
```

```{r}
mpsz_sp <- as(mpsz, "Spatial")
mpsz_sp
```

Computing the distance matrix

```{r}
dist <- spDists(mpsz_sp, 
                longlat = FALSE)

sz_names <- mpsz$SUBZONE_C

colnames(dist) <- paste0(sz_names)
rownames(dist) <- paste0(sz_names)
```

## 3.2 Importing Aspatial Data

```{r}
population <- read.csv("data/aspatial/pop.csv")
```

# 4.0 Preparing Flow Data

## 4.1 Importing the Origin Destination data

```{r}
odbus <- read_csv("data/aspatial/origin_destination_bus_202210.csv")

odbus$ORIGIN_PT_CODE <- as.factor(odbus$ORIGIN_PT_CODE)
odbus$DESTINATION_PT_CODE <- as.factor(odbus$DESTINATION_PT_CODE) 
```

### 4.1.1 Extracting the study data

```{r}
odbus6_9 <- odbus %>%
  filter(DAY_TYPE == "WEEKDAY") %>%
  filter(TIME_PER_HOUR >= 6 &
           TIME_PER_HOUR <= 9) %>%
  group_by(ORIGIN_PT_CODE,
           DESTINATION_PT_CODE) %>%
  summarise(TRIPS = sum(TOTAL_TRIPS))

datatable(odbus6_9)
```

Writing to rds

```{r}
write_rds(odbus6_9, "data/rds/odbus6_9.rds")
```

## 4.2 Importing bus stop data

```{r}
busstop <- st_read(dsn = "data/geospatial",
                   layer = "BusStop") %>%
  st_transform(crs = 3414)
```

## 4.3 Importing MPSZ-2019

```{r}
mpsz <- st_read(dsn = "data/geospatial",
                   layer = "MPSZ-2019") %>%
  st_transform(crs = 3414)
```

Write data to rds

```{r}
mpsz <- write_rds(mpsz, "data/rds/mpsz.rds")
```

## 4.4 Combing bus stop and mpsz

```{r}
busstop_mpsz <- st_intersection(busstop, mpsz) %>%
  select(BUS_STOP_N, SUBZONE_C) %>%
  st_drop_geometry()

datatable(busstop_mpsz)
```

Write data to rds

```{r}
write_rds(busstop_mpsz, "data/rds/busstop_mpsz.rds")  
```

```{r}
od_data <- left_join(odbus6_9 , busstop_mpsz,
            by = c("ORIGIN_PT_CODE" = "BUS_STOP_N")) %>%
  rename(ORIGIN_BS = ORIGIN_PT_CODE,
         ORIGIN_SZ = SUBZONE_C,
         DESTIN_BS = DESTINATION_PT_CODE)
```

To check for duplicates

```{r}
duplicate <- od_data %>%
  group_by_all() %>%
  filter(n()>1) %>%
  ungroup()

od_data <- unique(od_data)

od_data <- left_join(od_data , busstop_mpsz,
            by = c("DESTIN_BS" = "BUS_STOP_N")) 
```

```{r}
duplicate <- od_data %>%
  group_by_all() %>%
  filter(n()>1) %>%
  ungroup()

od_data <- unique(od_data)
```
