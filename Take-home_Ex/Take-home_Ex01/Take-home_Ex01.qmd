---
title: "Take-home Exercise 1: Application of Spatial Point Patterns Analysis to discover the geographical distribution of Grab hailing services in Singapore"
execute:
  eval: true
  echo: true
  warning: false
date: 01/23/2024
date-modified: last-modified
toc-depth: 2
code-annotations: hover
---

# 1.0 Introduction

## 1.1. Overview - Setting the Scene

Human mobility, the movement of human beings in space and time, reflects the spatial-temporal characteristics of human behavior. With the advancement Information and Communication Technologies (ICT) especially smart phone, a large volume of data related to human mobility have been collected. By using appropriate GIS analysis methods, these data are potentially useful in supporting smart city planning and management.

In Singapore, one of the important source of data related to human mobility is from [Land Transport Authority (LTA) DataMall](https://datamall.lta.gov.sg/content/datamall/en.html). Two data sets related to human mobility are provided by the portal, they are: Passenger Volume by Origin Destination Train Stations and Passenger Volume by Origin Destination Bus Stops. One of the limitation of these data sets is that their location are biased to either bus stops or MRT/LRT stations. In 2020, another very interesting human mobility data set called [Grab Posisi](https://engineering.grab.com/grab-posisi) was released by GRAB, one of the largest shared taxi operator in South-east Asia. There are two data sets been released and one of them is for Singapore.

## 1.2 Objectives

Geospatial analytics hold tremendous potential to address complex problems facing society.

In this study, we will be working on the following tasks:

-   Apply appropriate spatial point patterns analysis methods

-   Discover the geographical and spatial-temporal distribution of Grab hailing services locations in Singapore

## 1.3 Getting Started

In this take-home exercise, we will be using the following packages:

-   arrow

-   [sf](https://cran.r-project.org/web/packages/sf/) for handling geospatial data

-   [tidyverse](https://www.tidyverse.org/packages/) for performing data science tasks such as importing, wrangling and visualising data

```{r}
pacman::p_load(arrow, here, lubridate, maptools, tidyverse, tmap, sf, spatstat)
```

# 2.0 Data Acquisition

There will be 3 data sets used in this exercise:

| Data                                       | Format    | Description                                                 | Source                                                      |
|---------------|---------------|---------------------|---------------------|
| Grab Posisi                                | Parquet   | Grab taxi location points either by origins or destinations | [Grab](https://engineering.grab.com/grab-posisi)            |
| Road                                       | Shapefile | Road layer within Singapore excluding outer islands         | [Geofabrik download server](https://download.geofabrik.de/) |
| Master Plan 2019 Subzone Boundary (No Sea) | GeoJSON   | Singapore boundary layer excluding outer islands            | [Data.gov.sg](https://beta.data.gov.sg/)                    |

## 2.1 Extracting Geospatial and Aspatial Data Sets

Start by creating a new folder labeled `Take-home_Ex01`. Within this folder, create a sub-folder named `data`. Inside the `data` sub-folder, create two additional sub-folders and rename them `geospatial` and `aspatial` respectively.

Unzip the `malaysia-singapore-brunei-latest-free.shp.zip` folder and place all files, `MasterPlan2019SubzoneBoundaryNoSeaGEOJSON.geojson` into `geospatial` sub-folder.

Place all files from `GrabPosisi` into `aspatial` sub-folder.

::: callout-tip
## Tip

Did you observe that the file names from `GrabPosisi` and `MasterPlan2019SubzoneBoundaryNoSeaGEOJSON.geojson` are quite lengthy? Shortening them could make processing more convenient later on.

Alternatively, we can *list.files()* to get a list of filenames that contains `.parquet` extension.
:::

# 3.0 Geospatial Data Wrangling

## 3.1 Data Aggregation: Importing and Combining Aspatial parquet files

```{r}
#| eval: false
# Use list.files to get a list of filenames that match the pattern
parquet_files <- list.files(path = "data/aspatial", pattern = "\\.parquet$", full.names = TRUE)

grab_data <- data.frame()

for (file_path in parquet_files) {
  grab_data <- bind_rows(grab_data, read_parquet(file_path))
}
```

## 3.2 Data Export: Writing DataFrame to RDS file

```{r}
#| eval: false
write_rds(grab_data, "data/rds/grab_data.rds")
```

## 3.3 Data Import

### 3.3.1 Importing Aspatial Data - Grab Posisi data in RDS format

::: panel-tabset
## Reading file using read_rds()

```{r}
grab_df <- read_rds("data/rds/grab_data.rds")
```

## Displaying file structure using str()

```{r}
str(grab_df)
```
:::

What we can observe is that the grab data contains 30329685 observations and 9 variables. Notice that pingtimestamp is in the wrong format. It should be in date/time format and not integer. We will need to convert the data type in the next section (Data Preparation).

### 3.3.2 Importing Geospatial Data - Road data in shapefile format

We can import geospatial data into RStudio using *st_read()* of **sf** package. Letâ€™s try it now!

::: panel-tabset
## Reading file using st_read()

```{r}
roads_sf <- st_read(dsn="data/geospatial",
                   layer="gis_osm_roads_free_1")
```

## Displaying file structure using str()

```{r}
str(roads_sf)
```
:::

### 3.3.3 Importing Geospatial Data - Master Plan 2019 Subzone Boundary (No Sea) in shapefile format

::: panel-tabset
## Reading file using st_read()

```{r}
mpsz_sf <- st_read(dsn = "data/geospatial", 
                layer = "MPSZ-2019")
```

## Displaying file structure using str()

```{r}
str(mpsz_sf)
```
:::

We can observe that both `roads_sf` and `mpsz_sf` are currently using the **WGS 84** geographic coordinate system.

::: callout-note
## Summary Points

After looking at the file structure and contents of the 3 datasets, we need to perform the following preparations:

-   `grab_df`

    -   Converting data type

    -   Extracting trip starting location

    -   Converting aspatial data into geospatial data

-   `roads_sf` and `mpsz_sf`

    -   Performing projection transformation

    -   Extracting study area

    -   Getting road layer within Singapore excluding outer islands
:::

## 3.4 Data Preparation

[grab_df]{.underline}

### 3.4.1 Preparing and Converting `grab_df` into `grab_sf` (sf tibble data.framedata)

```{r}
# Converting data type using as_datetime()
grab_df$pingtimestamp <- as_datetime(grab_df$pingtimestamp)        # <1>

# Checking first n rows of data frame using head()
head(grab_df)                                                      # <2>  

grab_origins_sf <- grab_df %>% 
  group_by(trj_id) %>% 
  arrange(pingtimestamp) %>% 
  filter(row_number()==1) %>%
  mutate(weekday = wday(pingtimestamp,
                        label=TRUE,
                        abbr=TRUE),
         start_hr = factor(hour(pingtimestamp)),
         day = factor(mday(pingtimestamp))) %>%
  st_as_sf(coords = c("rawlng", "rawlat"),                         # <3>
           crs = 4326) %>%
  st_transform(crs = 3414)                                         # <4>

# Getting geometry details using st_geometry()
st_geometry(grab_origins_sf)
```

1.  Converting data type for `pingtimestamp` from integer into datetime using *as_datetime()* from **lubridate** package

2.  By default, the *head()* returns the first **6** rows

3.  Converting `grab_df` into sf tibble data.frame using *st_as_sf() and its location information*

    Note: Converting aspatial data into geospatial data

4.  Transforming coordinates using *st_transform()*

### 3.4.2 Creating ppp objects

```{r}
grab_origins_ppp <- grab_origins_sf %>%
  as('Spatial') %>%
  as('SpatialPoints') %>%
  as('ppp')
summary(grab_origins_ppp)
```

```{r}
# Checking for duplicated points
any(duplicated(grab_origins_ppp))
```

```{r}
plot(grab_origins_ppp)
```

### 3.4.3 Performing projection transformation

To perform projection transformation, we will *st_transform()*. Additionally, we will use *st_geometry()* to inspect the contents of `roads_sf` and `mpsz_sf` after the projection transformation.

[roads_sf]{.underline}

```{r}
# Transforming coordinates using st_transform()
roads_sf <- st_transform(roads_sf,
                           crs = 3414)

# Getting geometry details using st_geometry()
st_geometry(roads_sf)
```

[mpsz_sf]{.underline}

```{r}
# Transforming coordinates using st_transform()
mpsz_sf <- st_transform(mpsz_sf,
                          crs = 3414)

# Getting geometry details using st_geometry()
st_geometry(mpsz_sf)
```

Now, we observe that both `roads_sf` and `mpsz_sf` are using the **SVY21** projected coordinates system.

### 3.4.4 Extracting specific planning area - Downtown Core

Due to the intensive computational power required to conduct analysis on the whole of Singapore, we will be focusing on the Downtown Core planning area for this analysis as we want to investigate the spatial data point analysis in the Central Business District areas.

```{r}
sg_downtown_sf <- mpsz_sf %>%
  filter(PLN_AREA_N == "DOWNTOWN CORE")
```

```{r}
plot(sg_downtown_sf["PLN_AREA_N"], main = "DOWNTOWN CORE")
```

```{r}
sg_sf <- mpsz_sf %>%
  st_union()
```

### 3.4.5 Creating owin object - Downtown Core

```{r}
downtown_owin <- as.owin(sg_downtown_sf)
summary(downtown_owin)
```

```{r}
plot(downtown_owin)
```

### 3.4.6 Combining grab data points with study area - Downtown Core

```{r}
summary(downtown_owin)
```

```{r}
grab_origins_dt_ppp <- grab_origins_ppp[downtown_owin]
plot(grab_origins_dt_ppp, main="DOWNTOWN CORE")
```

### 3.4.7 Getting grab points within Downtown Core

```{r}
sg_downtown_grab_sf <- st_intersection(grab_origins_sf, sg_downtown_sf)
```

### 3.4.8 Getting road layer within Singapore excluding outer islands

In order to get the road layer within Singapore (excluding outer islands), we can use *st_intersection()* from **sf** package to confine the analysis to Singapore's boundary (in specifics, confining to the Downtown core planning area).

```{r}
sg_downtown_road_sf <- st_intersection(roads_sf, sg_downtown_sf)
```

### **3.4.9 Visualizing the Geospatial data**

```{r}
#tmap_mode('view')
#tm_shape(sg_downtown_grab_sf) + 
#  tm_dots() + 
#  tm_shape(sg_downtown_road_sf) +
#  tm_lines()
```

```{r}
tmap_mode('plot')
```

# 4.0 1^st^ Order Spatial Point Pattern Analysis (SPPA)

## 4.1 Kernel Density Estimation (KDE)

```{r}
kde_grab_origins_dt_bw <- density(grab_origins_dt_ppp,
                              sigma=bw.diggle,
                              edge=TRUE,
                              kernel="gaussian") 
```

```{r}
plot(kde_grab_origins_dt_bw, main = "KDE Grab Origins for Downtown Core")
```

```{r}
grab_origins_dt_ppp.km <- rescale(grab_origins_dt_ppp, 1000, "km")
```

```{r}
kde_grab_origins_dt_bw <- density(grab_origins_dt_ppp.km,
                              sigma=bw.diggle,
                              edge=TRUE,
                              kernel="gaussian")

plot(kde_grab_origins_dt_bw, main = "KDE Grab Origins for Downtown Core")
```
